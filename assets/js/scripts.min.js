var build,i,fetchProducts,jsonUrl="assets/data/set.json",loader,start,end,imgWrapper=React.createClass({displayName:"renderImage",getInitialState:function(){return{activeImage:"/assets/icons/white.gif",activeAngle:0,loading:!0,windowWidth:document.documentElement.clientWidth,windowHeight:document.documentElement.clientHeight,inputText:"",x:document.documentElement.clientWidth/2,y:document.documentElement.clientHeight/5}},getJson:function(a){start=(new Date).getTime(),$.ajax({product:a,url:jsonUrl,dataType:"json",success:function(b){this.setState({imageData:b.products[a],activeImage:b.products[a][0].src,activeAngle:b.products[a][0].angle,loading:!1}),console.log("product images fetched!"),clearInterval(fetchProducts),end=(new Date).getTime(),console.log("product image list fetched in",end-start,"ms")}.bind(this),error:function(a,b,c){console.error(jsonUrl,b,c.toString())}.bind(this)})},componentDidMount:function(){this.hammer=new Hammer(React.findDOMNode(this.refs.canvas)),this.hammer.get("pan").set({threshold:0,direction:Hammer.DIRECTION_ALL}),this.hammer.on("panup",this.panUp),this.hammer.on("pandown",this.panDown),this.hammer.on("panstart panmove",this.positionElement),this.draw(),window.addEventListener("resize",this.scale),fetchProducts=setInterval(this.getJson("id-12345"),500)},componentWillUnmount:function(){this.hammer.off("panup",this.panUp),this.hammer.off("pandown",this.panDown)},getContext:function(){return React.findDOMNode(this.refs.canvas).getContext("2d")},tick:function(){this._frameReady=!1,this.draw(),requestAnimationFrame(this.afterTick)},afterTick:function(){this._frameReady=!0,this._pendingTick&&(this._pendingTick=!1,this.batchedTick())},batchedTick:function(){return this._frameReady===!1?void(this._pendingTick=!0):void this.tick()},scale:function(){this.setState({windowWidth:document.documentElement.clientWidth,windowHeight:document.documentElement.clientHeight})},mapImages:function(a){if(this.state.imageData)for(i=0;i<this.state.imageData.length;i++)a===this.state.imageData[i].angle&&this.setState({activeImage:this.state.imageData[i].src})},panDown:function(a){console.log("Distance traveled: "+a.distance),console.log("X-pos: "+a.deltaX),console.log("Velocity: "+a.velocityX),this.state.activeAngle>0?(this.setState({activeAngle:this.state.activeAngle-30}),this.mapImages(this.state.activeAngle)):(this.setState({activeAngle:330}),this.mapImages(330))},panUp:function(a){console.log("Distance traveled: "+a.distance),console.log("X-pos: "+a.deltaX),console.log("Velocity: "+a.velocityX),this.state.activeAngle<330?(this.setState({activeAngle:this.state.activeAngle+30}),this.mapImages(this.state.activeAngle)):(this.setState({activeAngle:0}),this.mapImages(0))},incrementAngle:function(){this.state.activeAngle<330?(this.setState({activeAngle:this.state.activeAngle+30}),this.mapImages(this.state.activeAngle+30)):(this.setState({activeAngle:0}),this.mapImages(0))},decrementAngle:function(){this.state.activeAngle>0?(this.setState({activeAngle:this.state.activeAngle-30}),this.mapImages(this.state.activeAngle-30)):(this.setState({activeAngle:330}),this.mapImages(330))},draw:function(){this.clear(),this.showDebugInfo(),this.updateProductImage(),this.updateProductText(),this.batchedTick()},clear:function(){this.getContext().clearRect(0,0,this.state.windowWidth,this.state.windowHeight)},updateProductImage:function(){var a,b;b=new Image,b.src=this.state.activeImage,this.setState({imgWidth:b.width,imgHeight:b.height}),a=this.state.windowWidth/2-this.state.imgWidth/2,this.getContext().drawImage(b,a,0)},handleInput:function(a){var b=a.target.value;this.setState({inputText:b})},positionElement:function(a){console.log(a),console.log(a.srcEvent.pageX),console.log(a.deltaY),this.setState({x:a.srcEvent.pageX,y:a.srcEvent.pageY})},updateProductText:function(){this.getContext().save(),this.getContext().textAlign="center",this.getContext().font="14pt sans-serif",this.getContext().fillStyle="#f50",this.getContext().fillText(this.state.inputText,this.state.x,this.state.y),this.getContext().restore()},showDebugInfo:function(){this.getContext().save(),this.getContext().textAlign="start",this.getContext().font="14pt sans-serif",this.getContext().fillText("currently drawn:",5,50),this.getContext().fillText("Image: "+this.state.activeImage,5,150),this.getContext().fillText("Angle: "+this.state.activeAngle+"deg",5,100),this.getContext().restore()},render:function(){var a=this.state.windowWidth,b=this.state.imgHeight;return loader=[],build=[],this.state.imageData&&this.state.imageData.forEach(function(a){build.push(React.DOM.img({key:"angle-"+a.angle,alt:"product-view-"+a.angle,src:a.src,"data-angle":a.angle}))}),this.state.loading===!0&&(loader.push(React.DOM.img({className:"loader",key:"loader-img",alt:"loader",src:"/assets/icons/ajax-loader.svg"})),loader.push(React.DOM.span({className:"loader-text",key:"loader-text"},"Loading Product View..."))),React.DOM.div({className:"image-container"},loader,React.DOM.div({className:"preload"},build),React.DOM.canvas({className:"playground",width:a,height:b,ref:"canvas"}),React.DOM.input({className:"text-overlay",value:this.state.inputText,onChange:this.handleInput},"Enter some Text"),React.DOM.span({className:"intro"},"Click(Touch) and Drag or click the buttons to rotate"),React.DOM.button({onClick:this.incrementAngle,className:"button-right"},"R"),React.DOM.button({onClick:this.decrementAngle,className:"button-left"},"L"))}});React.render(React.createElement(imgWrapper),document.getElementById("main"));